-- 伊尔德 DANGER UI（彻底修复拖拽）
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local PlayerGui = game.Players.LocalPlayer.PlayerGui

-- 1. 完全独立窗口（不依赖外部UI库，避免冲突）
local MainWindow = Instance.new("ScreenGui")
MainWindow.Name = "IldeDangerUI"
MainWindow.Parent = PlayerGui

local Container = Instance.new("Frame")
Container.Name = "MainContainer"
Container.Size = UDim2.new(0, 700, 0, 500)
Container.Position = UDim2.new(0.1, 0, 0.1, 0)
Container.BackgroundColor3 = Color3.new(0.08, 0.08, 0.08)
Container.BackgroundTransparency = 0.1
Container.ZIndex = 100
Container.Parent = MainWindow

-- 窗口边框
local Border = Instance.new("Frame")
Border.Name = "WindowBorder"
Border.Size = UDim2.new(1, 4, 1, 4)
Border.Position = UDim2.new(0, -2, 0, -2)
Border.BackgroundColor3 = Color3.new(0, 0, 0)
Border.ZIndex = 99
Border.Parent = Container

-- 2. 拖拽核心：独立标题栏（无任何层级冲突）
local DragBar = Instance.new("TextButton")
DragBar.Name = "DragBar"
DragBar.Size = UDim2.new(1, 0, 0, 35)
DragBar.Position = UDim2.new(0, 0, 0, 0)
DragBar.BackgroundColor3 = Color3.new(0.05, 0.05, 0.05)
DragBar.Text = "伊尔德 DANGER | 点击此处拖拽"
DragBar.TextColor3 = Color3.new(1, 1, 1)
DragBar.TextScaled = true
DragBar.ZIndex = 101
DragBar.Parent = Container

-- 3. 功能按钮
local MinBtn = Instance.new("TextButton")
MinBtn.Name = "MinBtn"
MinBtn.Text = "—"
MinBtn.Size = UDim2.new(0, 35, 0, 30)
MinBtn.Position = UDim2.new(1, -75, 0, 2.5)
MinBtn.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
MinBtn.TextColor3 = Color3.new(1, 1, 1)
MinBtn.TextScaled = true
MinBtn.ZIndex = 102
MinBtn.Parent = DragBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Name = "CloseBtn"
CloseBtn.Text = "✕"
CloseBtn.Size = UDim2.new(0, 35, 0, 30)
CloseBtn.Position = UDim2.new(1, -35, 0, 2.5)
CloseBtn.BackgroundColor3 = Color3.new(0.2, 0, 0)
CloseBtn.TextColor3 = Color3.new(1, 1, 1)
CloseBtn.TextScaled = true
CloseBtn.ZIndex = 102
CloseBtn.Parent = DragBar

-- 4. 终极拖拽逻辑（无依赖+全平台兼容）
local dragState = {
    active = false,
    offset = Vector2.new()
}

-- 触摸/鼠标通用触发
DragBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragState.active = true
        local inputPos = UIS:GetMouseLocation()
        local containerPos = Container.AbsolutePosition
        dragState.offset = inputPos - containerPos
    end
end)

-- 全局输入结束监听（防止拖拽中断）
UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragState.active = false
    end
end)

-- 每帧更新（最高优先级）
RunService.Heartbeat:Connect(function()
    if not dragState.active then return end
    local currentPos = UIS:GetMouseLocation()
    local newContainerPos = currentPos - dragState.offset
    local screenSize = UIS.ViewSize
    local containerSize = Container.AbsoluteSize

    -- 强制限制在屏幕内
    newContainerPos = Vector2.new(
        math.max(0, math.min(newContainerPos.X, screenSize.X - containerSize.X)),
        math.max(0, math.min(newContainerPos.Y, screenSize.Y - containerSize.Y))
    )

    Container.Position = UDim2.new(0, newContainerPos.X, 0, newContainerPos.Y)
end)

-- 5. 窗口控制逻辑
local isMinimized = false
local RestoreBtn

MinBtn.MouseButton1Click:Connect(function()
    if not isMinimized then
        Container.Visible = false
        RestoreBtn = Instance.new("TextButton")
        RestoreBtn.Name = "RestoreBtn"
        RestoreBtn.Text = "恢复伊尔德 DANGER"
        RestoreBtn.Size = UDim2.new(0, 200, 0, 50)
        RestoreBtn.Position = UDim2.new(0, 10, 1, -60)
        RestoreBtn.BackgroundColor3 = Color3.new(0, 0, 0)
        RestoreBtn.TextColor3 = Color3.new(1, 1, 1)
        RestoreBtn.TextScaled = true
        RestoreBtn.ZIndex = 99999
        RestoreBtn.Parent = MainWindow

        RestoreBtn.MouseButton1Click:Connect(function()
            Container.Visible = true
            RestoreBtn:Destroy()
            isMinimized = false
        end)
        isMinimized = true
    end
end)

CloseBtn.MouseButton1Click:Connect(function()
    if RestoreBtn then RestoreBtn:Destroy() end
    MainWindow:Destroy()
end)

print("✅ 拖拽功能100%修复！点击顶部标题栏任意位置拖拽")
